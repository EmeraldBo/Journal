<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Timeless Journal</n></title>

  <style>
    html, body {
      margin: 0;
      padding: 0;
      background: #ccc;
      height: 100%;
      width: 100%;
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* Stable wrapper */
    #flipbook-wrapper {
      width: 90vw;
      height: 60vh;
      display: flex;
      justify-content: center;
      align-items: center;
      overflow: hidden;
    }

    /* Flipbook takes full wrapper size */
    #flipbook {
      width: 100%;
      height: 100%;
    }

    /* Each page is half the book width */
    #flipbook .page {
      width: 45vw;
      height: 60vh;
      background: white;
      box-sizing: border-box;
      padding: 20px;
      overflow: hidden;
      font-family: serif;
      font-size: clamp(14px, 2vw, 18px);
      line-height: 1.4;
      box-shadow: 0 0 10px rgba(0,0,0,0.3);
      position: relative;
    }
    #flipbook .page pre {
      white-space: pre-wrap;
      word-wrap: break-word;
      word-break: break-word;
    }
    #flipbook .page img {
      max-width: 100%;
      height: auto;
      display: block;
      margin-top: 1rem;
    }

    #centerText {
      position: fixed;
      top: 10vh;
      left: 50vw;
      transform: translate(-50%, -50%);
      font-size: clamp(12px, 4vw, 24px);
      font-family: sans-serif;
      background: rgba(0, 0, 0, 0.7);
      color: white;
      padding: 5px 10px;
      border-radius: 5px;
      z-index: 10000;
    }

    /* Optional style tweak for page‐number div */
    .page-number {
      font-weight: bold;
      opacity: 0.6;
    }
    .comment-section {
      position: absolute;
      bottom: 10px;
      left: 10px;
      right: 10px;
      font-size: 12px;
      font-family: sans-serif;
    }
    .comments-container {
      max-height: 80px;
      overflow-y: auto;
      margin-bottom: 5px;
      padding: 5px;
      background: #f0f0f0;
      border-radius: 4px;
    }
    .comment-input {
      width: 100%;
      height: 40px;
      resize: none;
    }
    .submit-comment {
      margin-top: 4px;
      float: right;
    }
  </style>

  <!-- 1) jQuery 1.9.1 (must load first) -->
  <script src="https://code.jquery.com/jquery-1.9.1.min.js"></script>
  <!-- 2) Turn.js 3 (must load second) -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/turn.js/3/turn.min.js"></script>

  <script>
    $(document).ready(function () {
      // Center‐screen hint
      const isPC = window.innerWidth >= 768;
      const centerText = document.createElement('div');
      centerText.id = 'centerText';
      centerText.textContent = 'Use Arrow Keys (PC) or Swipe/Tap (Mobile) to navigate.';
      document.body.appendChild(centerText);

      // Arrow navigation
      $(document).keydown(function(e) {
        switch (e.key) {
          case 'ArrowLeft':
            $('#flipbook').turn('previous');
            break;
          case 'ArrowRight':
            $('#flipbook').turn('next');
            break;
        }
      });

      // Helper functions
      function getCommentKey(pageNumber) {
        return 'comments_page_' + pageNumber;
      }
      function escapeHTML(str) {
        return str.replace(/[&<>"']/g, m => ({
          '&':'&amp;', '<':'&lt;', '>':'&gt;', '"':'&quot;', "'":'&#39;'
        }[m]));
      }
function loadComments(pageNumber) {
  const comments = JSON.parse(localStorage.getItem(getCommentKey(pageNumber)) || '[]');
  const commentSection = document.querySelector('.comments-container'); // Global one at bottom
  if (!commentSection) return;
  commentSection.innerHTML = comments.map(c =>
    `<div><strong>${c.user}:</strong> ${c.text}</div>`
  ).join('');
}

      function addComment() {
        const commentInput = document.querySelector('.comment-input');
        const rawText = commentInput.value.trim();
        if (rawText === '') {
          alert('Please write a comment before submitting.');
          return;
        }
        const commentText = escapeHTML(rawText);
        const usernameRaw = localStorage.getItem('journalUsername') || 'Guest';
        const username = escapeHTML(usernameRaw.charAt(0).toUpperCase() + usernameRaw.slice(1));

        const currentPage = $('#flipbook').turn('page');
        const key = getCommentKey(currentPage);
        const existing = JSON.parse(localStorage.getItem(key)) || [];
        existing.push({ user: username, text: commentText });
        localStorage.setItem(key, JSON.stringify(existing));

        commentInput.value = '';
        loadComments(currentPage);
      }

      // Initialize flipbook
      const pages = $('#flipbook .page');
      const pageCount = pages.length;
      if (pageCount < 2) {
        console.warn('⚠️ At least 2 pages are needed for flipping to work.');
      }
      $('#flipbook').turn({
        width:      400,
        height:     600,
        autoCenter: true,
        display:    'single',
        elevation:  50,
        gradients:  true,
        when: {
          turned: function (event, page) {
            loadComments(page);
          }
        }
      });

      // Preload first pages and add page numbers
      pages.each(function(index) {
        const p = index + 1;
        const pageDiv = $(this);
        const src = pageDiv.data('src');

        if (src) {
          pageDiv.load(src, function (response, status) {
            if (status === 'error') {
              pageDiv.html('<pre style="color:red;">⚠️ Failed to load</pre>');
            } else {
              pageDiv.data('loaded', true);
              loadComments(p);
            }
            // Add page number
            pageDiv.find('.page-number').remove();
            const numberEl = document.createElement('div');
            numberEl.textContent = p;
            numberEl.className = 'page-number';
            Object.assign(numberEl.style, {
              position:     'absolute',
              bottom:       '5px',
              right:        '10px',
              fontSize:     '12px',
              color:        '#fff',
              fontFamily:   'sans-serif',
              pointerEvents:'none'
            });
            pageDiv.append(numberEl);
          });
        } else {
          // Static page: just add page number and comment container
          pageDiv.find('.page-number').remove();
          const numberEl = document.createElement('div');
          numberEl.textContent = p;
          numberEl.className = 'page-number';
          Object.assign(numberEl.style, {
            position:     'absolute',
            bottom:       '5px',
            right:        '10px',
            fontSize:     '12px',
            color:        '#fff',
            fontFamily:   'sans-serif',
            pointerEvents:'none'
          });
          pageDiv.append(numberEl);
          loadComments(p);
        }
      });

      // Attach comment button handler
      document.querySelector('.submit-comment').addEventListener('click', addComment);

      // Load comments for initial page
      const initialPage = $('#flipbook').turn('page') || 1;
      loadComments(initialPage);

      // Touch swipe for mobile/desktop hybrid
      $('#flipbook').on('touchstart', function (event) {
        const xStart = event.originalEvent.touches[0].clientX;
        $(this).one('touchend', function (event) {
          const xEnd    = event.originalEvent.changedTouches[0].clientX;
          const distance= xStart - xEnd;
          if (Math.abs(distance) > 50) {
            if (distance > 0)   $(this).turn('next');
            else                $(this).turn('previous');
          }
        });
      });

      // Debug log override
      const originalConsoleLog  = console.log;
      const originalConsoleWarn = console.warn;
      const originalConsoleError= console.error;
      function appendToDebugLog(type, ...args) {
        const debugLog = document.getElementById('debug-log');
        if (debugLog) {
          const timestamp = new Date().toLocaleTimeString();
          const color = (type === 'log' ? 'lime' : type === 'warn' ? 'orange' : 'red');
          const prefix = type.toUpperCase();
          const msg = args.map(arg => (typeof arg === 'object' ? JSON.stringify(arg) : String(arg))).join(' ');
          debugLog.innerHTML += `<div style="color:${color};">[${timestamp}] ${prefix}: ${msg}</div>`;
        }
      }
      console.log = function (...args) {
        originalConsoleLog.apply(console, args);
        appendToDebugLog('log', ...args);
      };
      console.warn = function (...args) {
        originalConsoleWarn.apply(console, args);
        appendToDebugLog('warn', ...args);
      };
      console.error = function (...args) {
        originalConsoleError.apply(console, args);
        appendToDebugLog('error', ...args);
      };
      function toggleDebugLog() {
        const logEl = document.getElementById('debug-log');
        logEl.style.display = (logEl.style.display === 'none') ? 'block' : 'none';
      }
      $('#toggle-debug').on('click', toggleDebugLog);
    });
  </script>
</head>

<body>
  <div id="flipbook-wrapper">
    <div id="flipbook">
      <!-- Page 1 (static) -->
      <div class="page">
        <pre>
Timeless Journal
        
by ???
        </pre>
        <img src="doodles/doodle-title-2.jpg" alt="Timeless Journal title doodle">
      </div>

      <!-- Page 2 (dynamic) -->
      <div class="page" data-src="Pages/20XX/page1.html"></div>

      <!-- 2024 -->
      <div class="page" data-src="Pages/2024/page1.html"></div>
      <div class="page" data-src="Pages/2024/page2.html"></div>
      <div class="page" data-src="Pages/2024/page3.html"></div>

      <!-- January 2025 -->
      <div class="page" data-src="Pages/2025/January/page1.html"></div>
      <div class="page" data-src="Pages/2025/January/page2.html"></div>
      <div class="page" data-src="Pages/2025/January/page3.html"></div>

      <!-- February 2025 -->
      <div class="page" data-src="Pages/2025/February/page1.html"></div>

      <!-- March 2025 -->
      <div class="page" data-src="Pages/2025/March/page1.html"></div>
      <div class="page" data-src="Pages/2025/March/page2.html"></div>

      <!-- April 2025 -->
      <div class="page" data-src="Pages/2025/April/page1.html"></div>
      <div class="page" data-src="Pages/2025/April/page2.html"></div>

      <!-- May 2025 -->
      <div class="page" data-src="Pages/2025/May/page1.html"></div>
      <div class="page" data-src="Pages/2025/May/page2.html"></div>
      <div class="page" data-src="Pages/2025/May/page3.html"></div>
      <div class="page" data-src="Pages/2025/May/page4.html"></div>

      <!-- June 2025 -->
      <div class="page" data-src="Pages/2025/June/page1.html"></div>
      <div class="page" data-src="Pages/2025/June/page2.html"></div>
      <div class="page" data-src="Pages/2025/June/page3.html"></div>
      <div class="page" data-src="Pages/2025/June/page4.html"></div>

      <div class="page" data-src="Pages/Other/blank.html"></div>
      <div class="page" data-src="Pages/Other/blank.html"></div>
      <div class="page" data-src="Pages/Other/lettertitle.html"></div>

      <!-- Letter (SpecialMessage) -->
      <div class="page" data-src="Pages/SpecialMessage/Letter/page1.html"></div>
      <div class="page" data-src="Pages/SpecialMessage/Letter/page2.html"></div>
      <div class="page" data-src="Pages/SpecialMessage/Letter/page3.html"></div>
      <div class="page" data-src="Pages/SpecialMessage/Letter/page4.html"></div>
      <div class="page" data-src="Pages/SpecialMessage/Letter/page5.html"></div>
      <div class="page" data-src="Pages/SpecialMessage/Letter/page6.html"></div>
      <div class="page" data-src="Pages/SpecialMessage/Letter/page7.html"></div>
      <div class="page" data-src="Pages/SpecialMessage/Letter/page8.html"></div>
      <div class="page" data-src="Pages/SpecialMessage/Letter/page9.html"></div>
      <div class="page" data-src="Pages/SpecialMessage/Letter/page10.html"></div>
    </div> <!-- /#flipbook -->
  </div> <!-- /#flipbook-wrapper -->

  <!-- Comments -->
  <div class="comment-section">
    <h4>Comments</h4>
    <div class="comments-container"></div>
    <textarea class="comment-input" placeholder="Write a comment..."></textarea>
    <button onclick="askPasswordAndClear()">Reset Comments</button>
    <button class="submit-comment">Post Comment</button>
  </div>

  <!-- Collapsible Debug Log -->
  <div id="debug-log-wrapper" style="position: fixed; top: 0; left: 0; width: 100%; z-index: 9999; font-family: monospace; font-size: 12px;">
    <div id="toggle-debug" style="background: #222; color: #0f0; padding: 5px 10px; cursor: pointer;">
      ⚙️ Debug Log (click to toggle)
    </div>
    <div id="debug-log" style="background: black; color: lime; max-height: 150px; overflow-y: auto; padding: 10px; display: none; border-bottom: 2px solid lime;"></div>
  </div>

  <script>
    function askPasswordAndClear() {
      const password = prompt("Enter admin password to reset comments:");
      const correctPassword = "admin123";
      if (password === correctPassword) {
        clearComments();
      } else {
        alert("Incorrect password. Reset cancelled.");
      }
    }

    function clearComments() {
      for (let key in localStorage) {
        if (key.startsWith("comments_page_")) {
          localStorage.removeItem(key);
        }
      }
      location.reload();
    }
  </script>
</body>
</html>
